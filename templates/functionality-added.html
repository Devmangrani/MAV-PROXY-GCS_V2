<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Command Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #000;
            color: #0ff;
            overflow: hidden;
            height: 100%;
        }
        #container {
            display: flex;
            height: 100vh;
        }
        #visualizer {
            flex: 2;
            display: flex;
            flex-direction: column;
        }
        #map {
            flex: 1;
            height: 100%;
        }
        #mode-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 20, 40, 0.8);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
        }
        #controls {
            flex: 1;
            padding: 20px;
            background-color: rgba(0, 20, 40, 0.8);
            overflow-y: auto;
        }
        .button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #004499;
        }
        #messages {
            height: 200px;
            overflow-y: scroll;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            margin-top: 20px;
        }
        .parameter {
            margin-bottom: 10px;
        }
        .parameter input {
            background-color: #001f3f;
            color: #0ff;
            border: 1px solid #0066cc;
            padding: 5px;
        }
        #mission-planner {
            margin-top: 20px;
        }
        #hud {
            background-color: rgba(0, 20, 40, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .hud-data {
            display: grid;
            grid-template-columns: auto auto;
            gap: 10px;
        }
        .hud-data div {
            padding: 5px;
        }
        .label {
            font-weight: bold;
            color: #0ff;
        }
        .value {
            color: #00ff00;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="visualizer">
            <div id="mode-display">Current Mode: <span id="current-mode">-</span></div>
            <div id="map"></div>
        </div>
        <div id="controls">
            <h2>Drone Command Center</h2>
            <button class="button" onclick="armDrone()">Arm Drone</button>
            <button class="button" onclick="disarmDrone()">Disarm Drone</button>
            <button class="button" onclick="takeoff()">Takeoff</button>
            <button class="button" onclick="land()">Land</button>
            <button class="button" onclick="returnToLaunch()">Return to Launch</button>
            <button class="button" onclick="openVideoFeed()">Open Video Feed</button>

            <div id="flight-modes">
                <h3>Flight Modes</h3>
                <button class="button" onclick="setFlightMode('STABILIZE')">Stabilize</button>
                <button class="button" onclick="setFlightMode('ALT_HOLD')">Altitude Hold</button>
                <button class="button" onclick="setFlightMode('LOITER')">Loiter</button>
                <button class="button" onclick="setFlightMode('AUTO')">Auto</button>
                <button class="button" onclick="toggleRepositionMode()">Toggle Reposition Mode</button>
            </div>

            <div id="altitude-control">
                <h3>Altitude Control</h3>
                <input type="number" id="new-altitude" placeholder="New Altitude (m)">
                <button class="button" onclick="changeAltitude()">Change Altitude</button>
            </div>

            <div id="speed-control">
                <h3>Speed Control</h3>
                <input type="number" id="new-speed" placeholder="New Speed (m/s)" step="0.1" min="0">
                <button class="button" onclick="changeSpeed()">Set Speed (m/s)</button>
                <button class="button" onclick="increaseSpeed()">+1 m/s</button>
                <button class="button" onclick="decreaseSpeed()">-1 m/s</button>
            </div>

            <div id="mission-planner">
                <h3>Mission Planner</h3>
                <button class="button" onclick="toggleMissionPlanningMode()">Toggle Mission Planning Mode</button>
                <button class="button" onclick="clearMission()">Clear Mission</button>
                <button class="button" onclick="uploadMission()">Upload Mission</button>
                <div id="waypoint-list"></div>
            </div>

            <div id="parameters">
                <h3>Parameters</h3>
                <div class="parameter">
                    <label for="param-fence-radius">Geofence Radius (m):</label>
                    <input type="number" id="param-fence-radius" value="100">
                    <button class="button" onclick="setGeofence()">Set Geofence</button>
                </div>
            </div>

            <div id="hud">
                <h3>Heads-Up Display</h3>
                <div class="hud-data">
                    <div class="label">Roll:</div><div id="roll" class="value">-</div>
                    <div class="label">Pitch:</div><div id="pitch" class="value">-</div>
                    <div class="label">Yaw:</div><div id="yaw" class="value">-</div>
                    <div class="label">Roll Speed:</div><div id="rollspeed" class="value">-</div>
                    <div class="label">Pitch Speed:</div><div id="pitchspeed" class="value">-</div>
                    <div class="label">Yaw Speed:</div><div id="yawspeed" class="value">-</div>
                    <div class="label">Latitude:</div><div id="latitude" class="value">-</div>
                    <div class="label">Longitude:</div><div id="longitude" class="value">-</div>
                    <div class="label">Altitude:</div><div id="altitude" class="value">-</div>
                    <div class="label">Ground Speed:</div><div id="groundspeed" class="value">-</div>
                    <div class="label">Airspeed:</div><div id="airspeed" class="value">-</div>
                    <div class="label">Climb Rate:</div><div id="climbrate" class="value">-</div>
                    <div class="label">Battery:</div><div id="battery" class="value">-</div>
                </div>
            </div>

            <div id="messages"></div>
        </div>
    </div>
    <script>
        const socket = io();
        let map, droneMarker, geofenceCircle;
        let lastMapUpdate = 0;
        let pendingUpdates = {};
        let missionPlanningMode = false;
        let repositionMode = false;
        let waypoints = [];
        let repositionMarker = null;

        function initMap() {
            console.log("Initializing map...");
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            droneMarker = L.marker([0, 0]).addTo(map);

            map.on('click', onMapClick);
            console.log("Map initialized.");
        }

        function onMapClick(e) {
            if (missionPlanningMode) {
                const lat = e.latlng.lat.toFixed(6);
                const lon = e.latlng.lng.toFixed(6);
                const alt = prompt("Enter altitude for this waypoint (meters):", "10");

                if (alt !== null) {
                    addWaypoint(lat, lon, alt);
                }
            } else if (repositionMode) {
                const lat = e.latlng.lat.toFixed(6);
                const lon = e.latlng.lng.toFixed(6);
                const alt = prompt("Enter altitude for repositioning (meters):", "10");

                if (alt !== null) {
                    if (repositionMarker) {
                        map.removeLayer(repositionMarker);
                    }
                    repositionMarker = L.marker([lat, lon], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                    repositionMarker.bindPopup(`Reposition Target<br>Lat: ${lat}<br>Lon: ${lon}<br>Alt: ${alt}m`).openPopup();
                    repositionDrone(lat, lon, alt);
                }
            }
        }

        function updateDronePosition(lat, lon, alt) {
            droneMarker.setLatLng([lat, lon]);
            const now = Date.now();
            if (now - lastMapUpdate > 1000) {  // Update map view every second
                map.setView([lat, lon]);
                lastMapUpdate = now;
            }
        }

        socket.on('message', function(msg) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML += `<p style="color: ${msg.color}">${msg.text || JSON.stringify(msg.data)}</p>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            if (msg.type && msg.data) {
                const data = JSON.parse(msg.data);
                pendingUpdates[msg.type] = data;
            }
        });

        function updateHUD() {
            for (let [type, data] of Object.entries(pendingUpdates)) {
                switch (type) {
                    case 'ATTITUDE':
                        document.getElementById('roll').textContent = data['Roll'];
                        document.getElementById('pitch').textContent = data['Pitch'];
                        document.getElementById('yaw').textContent = data['Yaw'];
                        document.getElementById('rollspeed').textContent = data['Roll Speed'];
                        document.getElementById('pitchspeed').textContent = data['Pitch Speed'];
                        document.getElementById('yawspeed').textContent = data['Yaw Speed'];
                        break;
                    case 'GLOBAL_POSITION_INT':
                        document.getElementById('latitude').textContent = data['Latitude'];
                        document.getElementById('longitude').textContent = data['Longitude'];
                        document.getElementById('altitude').textContent = data['Relative Altitude'];
                        document.getElementById('groundspeed').textContent = data['Ground Speed'];
                        updateDronePosition(
                            parseFloat(data['Latitude']),
                            parseFloat(data['Longitude']),
                            parseFloat(data['Relative Altitude'])
                        );
                        break;
                    case 'VFR_HUD':
                        document.getElementById('airspeed').textContent = data['Airspeed'];
                        document.getElementById('climbrate').textContent = data['Climb Rate'];
                        break;
                    case 'SYS_STATUS':
                        document.getElementById('battery').textContent = data['Battery Remaining'];
                        break;
                    case 'HEARTBEAT':
                        document.getElementById('current-mode').textContent = data['Flight Mode'];
                        break;
                }
            }
            pendingUpdates = {};
            requestAnimationFrame(updateHUD);
        }

        function armDrone() {
            socket.emit('arm');
        }

        function disarmDrone() {
            socket.emit('disarm');
        }

        function takeoff() {
            const altitude = prompt("Enter takeoff altitude (meters):", "10");
            if (altitude !== null) {
                socket.emit('takeoff', parseFloat(altitude));
            }
        }

        function land() {
            socket.emit('land');
        }

        function returnToLaunch() {
            fetch('/rtl')
                .then(response => response.json())
                .then(data => console.log(data))
                .catch(error => console.error('Error:', error));
        }

        function setFlightMode(mode) {
            fetch('/set_flight_mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ mode: mode }),
            })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch(error => console.error('Error:', error));
        }

        function toggleRepositionMode() {
            repositionMode = !repositionMode;
            missionPlanningMode = false;

            if (repositionMode) {
                // Enable reposition mode
                if (droneMarker) {
                    const currentPosition = droneMarker.getLatLng();
                    if (repositionMarker) {
                        map.removeLayer(repositionMarker);
                    }
                    repositionMarker = L.marker(currentPosition, {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                    repositionMarker.bindPopup("Reposition Target").openPopup();
                }
                document.getElementById('messages').innerHTML += `<p>Reposition Mode: Enabled. Click on the map to set new position.</p>`;
            } else {
                // Disable reposition mode
                if (repositionMarker) {
                    map.removeLayer(repositionMarker);
                    repositionMarker = null;
                }
                document.getElementById('messages').innerHTML += `<p>Reposition Mode: Disabled</p>`;
            }
        }

        function repositionDrone(lat, lon, alt) {
            fetch('/reposition', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ lat: parseFloat(lat), lon: parseFloat(lon), alt: parseFloat(alt) }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    alert('Error: ' + data.error);
                } else {
                    console.log('Reposition data:', data);
                    alert(data.message);
                }
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Error: ' + error);
            });
        }

        function changeAltitude() {
            const newAltitude = document.getElementById('new-altitude').value;
            if (newAltitude !== null && newAltitude !== "") {
                fetch('/change_altitude', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ altitude: parseFloat(newAltitude) }),
                })
                .then(response => response.json())
                .then(data => console.log(data))
                .catch(error => console.error('Error:', error));
            }
        }

        function changeSpeed() {
            const newSpeed = document.getElementById('new-speed').value;
            if (newSpeed !== null && newSpeed !== "") {
                setDroneSpeed(parseFloat(newSpeed));
            }
        }

        function increaseSpeed() {
            const currentSpeed = parseFloat(document.getElementById('new-speed').value) || 0;
            setDroneSpeed(currentSpeed + 1);
        }

        function decreaseSpeed() {
            const currentSpeed = parseFloat(document.getElementById('new-speed').value) || 0;
            setDroneSpeed(Math.max(0, currentSpeed - 1));
        }

        function setDroneSpeed(speed) {
            fetch('/set_speed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ speed: speed }),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                document.getElementById('messages').innerHTML += `<p>${data.message || data.error}</p>`;
                document.getElementById('new-speed').value = speed;
            })
            .catch(error => console.error('Error:', error));
        }

        function toggleMissionPlanningMode() {
            missionPlanningMode = !missionPlanningMode;
            repositionMode = false;
            document.getElementById('messages').innerHTML += `<p>Mission Planning Mode: ${missionPlanningMode ? 'Enabled' : 'Disabled'}</p>`;
        }

        function addWaypoint(lat, lon, alt) {
            waypoints.push({lat, lon, alt});
            updateWaypointDisplay();

            L.marker([lat, lon]).addTo(map)
                .bindPopup(`Waypoint ${waypoints.length}: ${lat}, ${lon}, ${alt}m`);

            fetch('/add_waypoint', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ lat, lon, alt }),
            })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch(error => console.error('Error:', error));
        }

        function updateWaypointDisplay() {
            const waypointList = document.getElementById('waypoint-list');
            waypointList.innerHTML = '<h4>Waypoints:</h4>';
            waypoints.forEach((wp, index) => {
                waypointList.innerHTML += `<p>Waypoint ${index + 1}: ${wp.lat}, ${wp.lon}, ${wp.alt}m</p>`;
            });
        }

        function clearMission() {
            waypoints = [];
            updateWaypointDisplay();
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker && layer !== droneMarker && layer !== repositionMarker) {
                    map.removeLayer(layer);
                }
            });
            fetch('/clear_mission')
                .then(response => response.json())
                .then(data => console.log(data))
                .catch(error => console.error('Error:', error));
        }

        function uploadMission() {
            fetch('/upload_mission')
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    document.getElementById('messages').innerHTML += `<p>${data.message}</p>`;
                })
                .catch(error => console.error('Error:', error));
        }

        function setGeofence() {
            const radius = document.getElementById('param-fence-radius').value;
            fetch('/set_geofence', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ type: 'circle', radius: radius }),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (geofenceCircle) {
                    map.removeLayer(geofenceCircle);
                }
                geofenceCircle = L.circle(droneMarker.getLatLng(), {
                    radius: parseFloat(radius),
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.2
                }).addTo(map);
            })
            .catch(error => console.error('Error:', error));
        }

        function openVideoFeed() {
            const videoWindow = window.open('', 'Drone Video Feed', 'width=640,height=480');
            videoWindow.document.write(`
                <html>
                    <head>
                        <title>Drone Video Feed</title>
                        <style>
                            body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #000; }
                            img { max-width: 100%; max-height: 100%; object-fit: contain; }
                        </style>
                    </head>
                    <body>
                        <img src="${window.location.origin}/video_feed" alt="Live Drone Feed">
                    </body>
                </html>
            `);
        }

        function resizeMap() {
            if (map) {
                map.invalidateSize();
            }
        }

        window.addEventListener('resize', resizeMap);

        window.onload = function() {
            console.log("Window loaded. Initializing map and HUD...");
            initMap();
            requestAnimationFrame(updateHUD);
            resizeMap();
        };
    </script>
</body>
</html>
